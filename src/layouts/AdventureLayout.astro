---
/**
 * ADVENTURE LAYOUT - Updated for Horizontal Initiative Track
 */

import BaseLayout from './BaseLayout.astro';
import GameInitializer from '../lib/engine/components/GameInitializer';
import EngineDirector from '../lib/engine/components/EngineDirector';
import SurgeOverlay from '../lib/engine/components/SurgeOverlay';
import DirectorDrawer from '../lib/engine/components/DirectorDrawer';
import SmartDrawerController from '../lib/engine/components/SmartDrawerController';
import DraggableQueue from '../lib/engine/components/DraggableQueue'; // Moved here
import ErrorBoundary from '../components/ErrorBoundary';
import { Toaster } from 'sonner';
import type { Resource, Rule, SurgeEvent } from '../lib/engine/types';

interface Props {
  title: string;
  description: string;
  resources: Resource[];
  rules: Rule[];
  surges: SurgeEvent[];
  combatants?: any[];
  maxTurns?: number;
}

const { title, description, resources, rules, surges, combatants = [], maxTurns } = Astro.props;
---

<BaseLayout title={title} description={description}>
  {/* Engine Logic Components */}
  <ErrorBoundary client:only="react">
    <GameInitializer 
      client:only="react"
      adventureSlug={Astro.params.slug || 'demo'}
      resources={resources}
      rules={rules}
      combatants={combatants}
    />
  </ErrorBoundary>
  
  <ErrorBoundary client:only="react">
    <EngineDirector client:only="react" rules={rules} surges={surges} />
  </ErrorBoundary>
  
  <ErrorBoundary client:only="react">
    <SurgeOverlay client:only="react" />
  </ErrorBoundary>
  
  <ErrorBoundary client:only="react">
    <SmartDrawerController client:only="react" />
  </ErrorBoundary>
  
  <Toaster client:only="react" position="top-center" />
  
  <div class="min-h-screen bg-forge-dark flex flex-col">
    
    {/* 1. TOP BAR: INITIATIVE TRACKER */}
    <ErrorBoundary client:only="react">
      <div class="sticky top-0 z-30 w-full">
        <DraggableQueue client:only="react" />
      </div>
    </ErrorBoundary>

    {/* 2. MAIN LAYOUT (Content + Sidebar) */}
    <div class="flex flex-col md:flex-row flex-1 relative">
        
        {/* Story Content */}
        <main class="flex-1 p-6 pb-40 md:pb-6 md:h-[calc(100vh-140px)] md:overflow-y-auto">
          <div class="max-w-prose mx-auto pt-4">
            <div class="prose prose-invert prose-forge">
              <h1 class="text-4xl font-bold mb-4 animate-forge-flow">{title}</h1>
              <p class="text-slate-300 mb-8">{description}</p>
              <slot />
            </div>
          </div>
        </main>
        
        {/* Controls Sidebar */}
        <ErrorBoundary client:only="react">
          <DirectorDrawer 
            client:only="react"
            resources={resources}
            combatants={combatants} // Passed for data, but Queue is rendered above
            maxTurns={maxTurns}
          />
        </ErrorBoundary>
    </div>
  </div>
</BaseLayout>

<style>
  .prose-forge {
    --tw-prose-body: theme('colors.slate.200');
    --tw-prose-headings: theme('colors.white');
    --tw-prose-quotes: theme('colors.yellow.100');
    --tw-prose-quote-borders: theme('colors.yellow.500');
    --tw-prose-code: theme('colors.blue.300');
  }
  
  .prose-forge blockquote {
    font-family: 'Georgia', serif;
    font-style: italic;
    border-left: 4px solid var(--forge-gold);
    background: rgba(245, 158, 11, 0.1);
    padding: 1rem 1.5rem;
    border-radius: 0.5rem;
  }
  
  /* Hide scrollbar for initiative track */
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>