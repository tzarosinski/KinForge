---
/**
 * DYNAMIC ADVENTURE ROUTE
 * * Loads the interactive game engine for a specific adventure.
 * * FIX: Explicitly fetches full adventure data to ensure 'Content' is present.
 */

import { getAdventure, getAllAdventures, FALLBACK_ADVENTURE } from '../../lib/keystatic-reader';
import AdventureLayout from '../../layouts/AdventureLayout.astro';
import AdventureError from '../../components/AdventureError.astro';
import MarkdownFallback from '../../components/MarkdownFallback.astro';
import type { Resource, Rule, SurgeEvent } from '../../lib/engine/types';

// 1. Generate paths for all adventures (Metadata only)
export async function getStaticPaths() {
  const adventures = await getAllAdventures();
  return adventures.map(adv => ({
    params: { slug: adv.slug },
  }));
}

// 2. Get the specific slug
const { slug } = Astro.params;

// 3. FETCH FULL DATA (Crucial Step)
// We fetch here to ensure we get the 'Content' component and all rules
const adventureData = await getAdventure(slug as string);

// 4. Handle "Not Found" or Error
if (!adventureData) {
  throw new Error(`Adventure not found: ${slug}`);
}

const { 
  title: rawTitle, 
  description, 
  resources, 
  rules, 
  surges, 
  combatants = [], 
  maxTurns,
  renderMode = 'markdoc',
  Content,
  rawContent,
  contentError
} = adventureData;

// 5. Helper: Prettify Titles
// Transforms "siege-of-ironhold" -> "Siege of Ironhold"
const formatTitle = (str: string) => {
  if (!str) return '';
  // If it has spaces, it's likely already formatted. Return as is.
  if (str.includes(' ')) return str;
  // If it's a slug (hyphens), format it.
  return str
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
};

const displayTitle = formatTitle(rawTitle);

// 6. Safe Defaults
const safeResources: Resource[] = resources || FALLBACK_ADVENTURE.resources;
const safeRules: Rule[] = rules || [];
const safeSurges: SurgeEvent[] = surges || [];
const safeCombatants: any[] = combatants || [];

console.log(`ðŸŽ® [${slug}] Adventure loaded:`, {
  title: displayTitle,
  renderMode,
  resources: safeResources.length,
  combatants: safeCombatants.length
});
---

<AdventureLayout
  title={displayTitle}
  description={description}
  resources={safeResources}
  rules={safeRules}
  surges={safeSurges}
  combatants={safeCombatants}
  maxTurns={maxTurns}
>
  
  {/* Markdoc Success */}
  {renderMode === 'markdoc' && Content && (
    <Content />
  )}
  
  {/* Fallback Markdown Renderer */}
  {renderMode === 'fallback' && rawContent && (
    <MarkdownFallback rawContent={rawContent} showWarning={false} />
  )}
  
  {/* Error State */}
  {renderMode === 'error' && (
    <AdventureError 
      error={contentError} 
      adventureName={displayTitle}
      showSafeMode={false}
    />
  )}
</AdventureLayout>